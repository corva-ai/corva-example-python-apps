comma = ,
srcs_comma_sep = src,tests
srcs = $(subst $(comma), ,$(srcs_comma_sep))
unit_test_path = tests/test_unit.py
manifest_name = manifest.json
package_name = package.zip

## help: Show this help.
.PHONY: help
help: Makefile
	@sed -n 's/^##\s//p' $<

## install: Install all requirements.
.PHONY: install
install:
	@pip install -U -r requirements.txt
	@pip install -U -r requirements-test.txt

## test: Run tests and measure code coverage.
.PHONY: test
test:
	@coverage run -m --branch			 \
 	--source=$(srcs_comma_sep) 			 \
	pytest $(unit_test_path)

## testcov: Run tests and display code coverage in the browser.
.PHONY: testcov
testcov: test
	@coverage html --precision=2 --fail-under=100
	@x-www-browser htmlcov/index.html

## lint: Run linter.
.PHONY: lint
lint:
	@flake8 --max-line-length 88 $(srcs)

## clean: Delete autogenerated files.
.PHONY: clean
clean:
	@-python3 -Bc "for p in __import__('pathlib').Path('.').rglob('*.py[co]'): p.unlink()"
	@-python3 -Bc "for p in __import__('pathlib').Path('.').rglob('__pycache__'): p.rmdir()"
	@-rm -rf .pytest_cache
	@-rm -rf htmlcov
	@-rm .coverage
	@-rm $(package_name)

## build: Build .zip package.
.PHONY: build
build: PROVIDER ?=
build: DEPTH_MILESTONE ?=
build: clean
	@sed										  \
	-e 's|{PROVIDER}|$(PROVIDER)|g'  			  \
	-e 's|{DEPTH_MILESTONE}|$(DEPTH_MILESTONE)|g' \
	$(manifest_name)				 			  \
	> $(manifest_name).new
	@zip -r9q - src/ requirements.txt $(manifest_name).new >$(package_name)
	@printf "@ $(manifest_name).new\n@=$(manifest_name)\n" \
	| zipnote -w $(package_name)
	@rm $(manifest_name).new
